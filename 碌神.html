<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>åƒç´ å®ˆå€™ Â· ä½™ä¸å†™ç»™æ¨æ¡ƒï¼ˆå†™ç»™æ‡µæ‡µï¼‰</title>
  <style>
    :root{
      --bg:#0b0f14; --ink:#e5e7eb; --muted:#9ca3af;
      --accent:#22c55e; --pink:#ec4899; --warn:#f59e0b; --danger:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,"PingFang SC","Microsoft YaHei",sans-serif;background:var(--bg);color:var(--ink);}
    .wrap{max-width:980px;margin:0 auto;padding:14px 12px 22px;}
    .top{display:flex;justify-content:space-between;align-items:flex-end;gap:10px;margin:6px 2px 10px}
    .title{font-weight:900;letter-spacing:.5px;font-size:18px}
    .sub{color:var(--muted);font-size:12px;line-height:1.4}
    .grid{display:grid;grid-template-columns:1.15fr .85fr;gap:12px}
    @media (max-width:920px){ .grid{grid-template-columns:1fr} }

    .card{
      background:linear-gradient(180deg,#0f172a,#0b1220);
      border:1px solid rgba(255,255,255,.08);
      border-radius:18px;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
      overflow:hidden;
      position:relative;
    }
    .pad{padding:12px}

    /* Scene */
    .scene{
      position:relative;
      border-bottom:1px solid rgba(255,255,255,.06);
      height:260px;
      overflow:hidden;
      background:
        radial-gradient(circle at 20% 60%, rgba(34,197,94,.18), transparent 45%),
        radial-gradient(circle at 75% 35%, rgba(236,72,153,.14), transparent 46%),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    }
    .scene svg{width:100%;height:100%;display:block;opacity:.98}
    .hud{
      position:absolute;left:10px;top:10px;display:flex;gap:8px;flex-wrap:wrap;
      pointer-events:none; z-index:5;
    }
    .badge{pointer-events:none;font-size:12px;color:var(--muted);padding:6px 10px;border:1px solid rgba(255,255,255,.10);border-radius:999px;background:rgba(0,0,0,.25)}
    .badge strong{color:var(--ink);font-weight:900}
    .hotspots{position:absolute;inset:0;z-index:4}
    .spot{
      position:absolute;border:1px dashed rgba(255,255,255,.26);border-radius:14px;
      background:rgba(255,255,255,.02);
      display:flex;align-items:center;justify-content:center;
      color:rgba(229,231,235,.88);font-size:12px;
      cursor:pointer; user-select:none;
      transition:transform .08s ease, background .2s ease, border-color .2s ease;
      -webkit-tap-highlight-color:transparent;
      padding:6px;
      text-align:center;
      white-space:pre-line;
    }
    .spot:active{transform:translateY(1px)}
    .spot:hover{background:rgba(255,255,255,.045);border-color:rgba(255,255,255,.34)}
    .spot.hidden{display:none}

    /* Progress */
    .bar{height:10px;border-radius:999px;background:rgba(255,255,255,.08);overflow:hidden;margin-top:10px}
    .bar i{display:block;height:100%;width:0%;background:linear-gradient(90deg,var(--accent),#60a5fa);transition:width .35s ease}

    /* Dialog */
    .chapter{
      display:inline-flex;gap:8px;align-items:center;
      margin:10px 0 8px;
      padding:8px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.20);
      font-weight:900;font-size:13px;
    }
    .chapter small{color:var(--muted);font-weight:800}
    .dialog{
      min-height:170px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.25);
      border-radius:16px;
      padding:12px;
      line-height:1.75;
      font-size:15px;
      white-space:pre-wrap;
    }
    .row{display:flex;gap:10px;margin-top:10px}
    button{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:var(--ink);
      border-radius:14px;
      padding:11px 10px;
      font-size:14px;
      cursor:pointer;
      transition:transform .05s ease, background .2s ease;
      -webkit-tap-highlight-color:transparent;
    }
    button:active{transform:translateY(1px)}
    button.primary{background:rgba(34,197,94,.14);border-color:rgba(34,197,94,.25)}
    button.danger{background:rgba(239,68,68,.12);border-color:rgba(239,68,68,.25)}
    button.ghost{background:rgba(0,0,0,.18)}
    .row button{flex:1}

    .input{
      display:flex;gap:10px;margin-top:10px;
      padding:10px;border-radius:14px;border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.18);
    }
    input{flex:1;border:0;outline:none;background:transparent;color:var(--ink);font-size:14px;}
    .hint{color:var(--muted);font-size:12px;margin-top:8px;line-height:1.5}

    /* Right panel */
    .panelTitle{font-weight:950;margin:0 0 8px;font-size:14px}
    .box{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.22);
      border-radius:16px;
      padding:10px;
    }
    .kv{display:flex;justify-content:space-between;gap:10px;color:var(--muted);font-size:12px;line-height:1.6}
    .kv strong{color:var(--ink)}
    .pillRow{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .pill{
      font-size:12px;padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      color:rgba(229,231,235,.92);
      cursor:pointer; user-select:none;
    }
    .pill:active{transform:translateY(1px)}
    .divider{height:1px;background:rgba(255,255,255,.08);margin:10px 0}
    .small{font-size:12px;color:var(--muted)}
    .task{display:flex;gap:10px;align-items:flex-start;padding:8px 6px;border-radius:12px}
    .task.done{background:rgba(34,197,94,.08);border:1px solid rgba(34,197,94,.18)}
    .task .tname{font-size:13px;font-weight:900}
    .task .tdesc{font-size:12px;color:var(--muted);margin-top:2px;line-height:1.4}
    .check{
      width:18px;height:18px;border-radius:6px;border:1px solid rgba(255,255,255,.18);
      display:flex;align-items:center;justify-content:center;
      margin-top:1px;
      flex:0 0 18px;
    }
    .task.done .check{border-color:rgba(34,197,94,.35);background:rgba(34,197,94,.14)}
    .check span{font-size:12px;opacity:.0}
    .task.done .check span{opacity:1}

    /* NPC row */
    .npcRow{display:flex;gap:10px;flex-wrap:wrap}
    .npcBtn{
      width:calc(33.33% - 6.7px);
      min-width:110px;
      display:flex;gap:10px;align-items:center;
      padding:10px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color:transparent;
    }
    .npcBtn:active{transform:translateY(1px)}
    .npcBtn.locked{opacity:.55; cursor:not-allowed;}
    .avatar{
      width:36px;height:36px;border-radius:14px;
      display:flex;align-items:center;justify-content:center;
      background:rgba(0,0,0,.30);
      border:1px solid rgba(255,255,255,.10);
      font-size:18px;
      flex:0 0 36px;
    }
    .npcMeta{min-width:0}
    .npcMeta b{display:block;font-size:13px}
    .npcMeta span{display:block;font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    /* Effects */
    .overlay{position:absolute;inset:0;pointer-events:none;z-index:3}
    .bubble{
      position:absolute; bottom:-30px;
      animation: floatUp 2.9s ease-in forwards;
      opacity:.95;
      filter: drop-shadow(0 6px 12px rgba(0,0,0,.35));
      font-size:18px;
    }
    @keyframes floatUp{
      0%{transform:translateY(0) scale(.9); opacity:0;}
      12%{opacity:1;}
      100%{transform:translateY(-300px) scale(1.15); opacity:0;}
    }
    .banner{
      position:absolute;left:50%;top:14px;transform:translateX(-50%);
      padding:10px 14px;border-radius:999px;
      border:1px solid rgba(236,72,153,.35);
      background:rgba(236,72,153,.16);
      font-weight:950;letter-spacing:.5px;
      display:none;
      z-index:6;
    }
    .fade{
      position:absolute;inset:0;background:rgba(0,0,0,0);
      transition:background .85s ease;
      pointer-events:none;
      z-index:2;
    }
    .toast{
      position:absolute;left:50%;bottom:14px;transform:translateX(-50%);
      padding:10px 12px;border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.60);
      font-size:13px;color:var(--ink);
      opacity:0;transition:opacity .25s ease, transform .25s ease;
      max-width:92%;text-align:center;
      z-index:7;
    }
    .toast.show{opacity:1;transform:translateX(-50%) translateY(-6px)}

    /* Branch modal */
    .modalBack{
      position:absolute;inset:0;background:rgba(0,0,0,.55);
      display:none;align-items:center;justify-content:center;
      z-index:20;padding:14px;
    }
    .modal{
      width:min(520px, 100%);
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background:linear-gradient(180deg, rgba(15,23,42,.92), rgba(11,18,32,.92));
      box-shadow:0 18px 60px rgba(0,0,0,.55);
      padding:14px;
    }
    .modal h4{margin:0 0 6px;font-size:15px;font-weight:950}
    .modal p{margin:0 0 10px;color:var(--muted);font-size:12px;line-height:1.5}
    .modal .opt{display:flex;flex-direction:column;gap:8px}
    .opt button{width:100%;text-align:left}
    .opt button b{display:block;font-size:14px}
    .opt button span{display:block;color:var(--muted);font-size:12px;margin-top:2px}
  </style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div>
      <div class="title">åƒç´ å®ˆå€™ Â· ä½™ä¸å†™ç»™æ¨æ¡ƒï¼ˆå†™ç»™æ‡µæ‡µï¼‰</div>
      <div class="sub">NPCé›†åˆï¼šå¦¹å¦¹/å“¥å“¥/å…»çˆ¶æ¯ï¼ˆç‚¹å‡»å¤´åƒè§¦å‘éšè—å˜±æ‰˜ï¼‰ã€‚ä»»åŠ¡/åˆ†æ”¯/å¤šåœºæ™¯/ç¦»çº¿å­˜æ¡£ã€‚</div>
    </div>
    <div class="sub">v2.4-fixedï¼ˆå·²ä¿®å¤äº¤äº’ï¼‰</div>
  </div>

  <div class="grid">
    <!-- Left -->
    <div class="card" id="leftCard">
      <div class="scene" id="scene">
        <div class="hud">
          <span class="badge">NPCï¼š<strong>ä½™ä¸</strong></span>
          <span class="badge" id="b_day">ç¬¬ <strong>1</strong> å¤©</span>
          <span class="badge" id="b_server">æœåŠ¡å™¨ï¼š<strong>è¿è¡Œä¸­</strong></span>
        </div>

        <div class="banner" id="banner">æˆ‘æ›´çˆ±ä½ </div>
        <div class="fade" id="fade"></div>
        <div class="overlay" id="overlay"></div>
        <div class="toast" id="toast"></div>

        <div id="sceneArt"></div>

        <div class="hotspots">
          <!-- home -->
          <div class="spot" id="spot_pond"   style="left:6%; top:58%; width:29%; height:30%;">æ± å¡˜\nï¼ˆä¿®å¤ï¼‰</div>
          <div class="spot" id="spot_garden" style="left:38%; top:62%; width:26%; height:26%;">èœå›­\nï¼ˆä¿®å¤ï¼‰</div>
          <div class="spot" id="spot_cabinet"style="left:68%; top:62%; width:26%; height:26%;">åºŠå¤´æŸœ\nï¼ˆæ‹¿ç³–ï¼‰</div>
          <div class="spot" id="spot_peach"  style="left:54%; top:16%; width:40%; height:36%;">åé™¢æ¡ƒæ—\nï¼ˆç§æ ‘ï¼‰</div>

          <!-- cinema -->
          <div class="spot hidden" id="spot_ticket" style="left:8%; top:18%; width:34%; height:32%;">åº§ä½æ—\nï¼ˆç”µå½±ç¥¨ï¼‰</div>

          <!-- bakery -->
          <div class="spot hidden" id="spot_envelope" style="left:60%; top:58%; width:34%; height:28%;">æŸœå°\nï¼ˆæ³›é»„ä¿¡å°ï¼‰</div>

          <!-- cat -->
          <div class="spot hidden" id="spot_urn" style="left:58%; top:63%; width:36%; height:24%;">éª¨ç°ç›’</div>

          <!-- final -->
          <div class="spot hidden" id="spot_sms" style="left:8%; top:58%; width:34%; height:28%;">çŸ­ä¿¡\nï¼ˆå…³æœï¼‰</div>
        </div>

        <!-- Branch modal -->
        <div class="modalBack" id="modalBack">
          <div class="modal">
            <h4>å…³æœå‰ä¸€åˆ»ï¼Œä½ æƒ³å¯¹æˆ‘è¯´ä»€ä¹ˆï¼Ÿ</h4>
            <p>æ¨æ¡ƒï¼Œä½ åªéœ€è¦é€‰ä¸€ç§è¯´æ³•ã€‚å®ƒä¼šå½±å“ç»ˆç« çš„æœ€åä¸¤å¥ï¼ˆå¹¶å†™å…¥å­˜æ¡£ï¼‰ã€‚</p>
            <div class="opt">
              <button class="primary" id="optTruth">
                <b>A. è¯´çœŸè¯</b>
                <span>â€œæˆ‘æƒ³ä½ ã€‚â€ï¼ˆæŠŠæ€å¿µè¯´å‡ºå£ï¼‰</span>
              </button>
              <button id="optBless">
                <b>B. åªè¯´ç¥ç¦</b>
                <span>â€œæˆ‘ä¼šå¥½å¥½çš„ã€‚â€ï¼ˆæŠŠä½ ç•™åœ¨æœªæ¥é‡Œï¼‰</span>
              </button>
              <button id="optJoke">
                <b>C. è®²ä¸ªç¬‘è¯</b>
                <span>â€œä½ çœŸå•°å—¦ã€‚â€ï¼ˆç”¨è½»æ¾æ©ä½å“½å’½ï¼‰</span>
              </button>
            </div>
            <div class="small" style="margin-top:10px;">é€‰å®Œåç»§ç»­æ¨è¿›å‰§æƒ…å³å¯çœ‹åˆ°ä¸åŒç»ˆç« æ–‡å­—ã€‚</div>
          </div>
        </div>
      </div>

      <div class="pad">
        <div class="bar" title="å®¶å›­ä¿®å¤è¿›åº¦"><i id="progress"></i></div>
        <div class="chapter"><span id="ch">åºç« </span> <small id="chHint">ç”°å›­å°å±‹</small></div>
        <div class="dialog" id="dialog"></div>

        <div class="row">
          <button class="primary" id="btnNext">ç»§ç»­</button>
          <button class="ghost" id="btnAuto">è‡ªåŠ¨ï¼šå…³</button>
          <button class="danger" id="btnReset">é‡å¼€</button>
        </div>

        <div class="row">
          <button id="btnWater">æ‰“æ°´</button>
          <button id="btnFish">é’“é±¼</button>
          <button id="btnWeed">é™¤è‰</button>
          <button id="btnPeach">ç§æ¡ƒæ—</button>
        </div>

        <div class="input">
          <input id="say" placeholder='å¯¹æˆ‘è¯´å¥è¯å§ï¼Œæ¨æ¡ƒâ€¦â€¦ï¼ˆæˆ‘çˆ±ä½ /ä¸å¼€å¿ƒ/ç”Ÿæ—¥å¿«ä¹/å†è§/å•°å—¦ï¼‰' />
          <button class="primary" id="btnSend" style="flex:0 0 86px">å‘é€</button>
        </div>

        <div class="hint">
          ç©æ³•ï¼šç‚¹ã€è™šçº¿æ¡†çƒ­ç‚¹ã€‘åšä»»åŠ¡æ‹¿é“å…·ï¼›å³ä¾§ç‚¹ã€NPCå¤´åƒã€‘è§¦å‘éšè—å˜±æ‰˜ã€‚<br/>
          è¾“å…¥ â€œæˆ‘çˆ±ä½ â€ ä¼šå‡ºç°ç²‰è‰²æ³¡æ³¡ï¼›è¾“å…¥â€œä¸å¼€å¿ƒâ€ä¼šæç¤ºåºŠå¤´æŸœç³–æœã€‚<br/>
          å…³æœå‰ä¼šå‡ºç°ä¸€æ¬¡ã€åˆ†æ”¯é€‰æ‹©ã€‘ã€‚
        </div>
      </div>
    </div>

    <!-- Right -->
    <div class="card">
      <div class="pad">
        <h3 class="panelTitle">NPCé›†åˆï¼ˆç‚¹å¤´åƒè¯´è¯ï¼‰</h3>
        <div class="box">
          <div class="npcRow" id="npcRow"></div>
          <div class="small" style="margin-top:8px;">æç¤ºï¼šéƒ¨åˆ†NPCä¼šåœ¨åæœŸç« èŠ‚è§£é”ï¼ˆåƒâ€œæœ€åçš„å˜±æ‰˜â€ï¼‰ã€‚</div>
        </div>

        <div style="height:12px"></div>

        <h3 class="panelTitle">ä»»åŠ¡åˆ—è¡¨</h3>
        <div class="box" id="taskBox"></div>

        <div style="height:12px"></div>

        <h3 class="panelTitle">èƒŒåŒ…</h3>
        <div class="box">
          <div class="kv"><span>ç³–æœ</span><strong id="invCandy">0</strong></div>
          <div class="kv"><span>æ¡ƒæ ‘ç§å­</span><strong id="invSeed">0</strong></div>
          <div class="kv"><span>è€å¼è›‹ç³•ï¼ˆç”Ÿæ—¥å¿«ä¹ï¼‰</span><strong id="invCake">0/3</strong></div>
          <div class="kv"><span>ç”µå½±ç¥¨</span><strong id="invTicket">æœªè·å¾—</strong></div>
          <div class="kv"><span>ä¿¡å°</span><strong id="invEnvelope">æœªè·å¾—</strong></div>
          <div class="kv"><span>åˆ†æ”¯é€‰æ‹©</span><strong id="invBranch">æœªé€‰æ‹©</strong></div>
          <div class="divider"></div>
          <div class="pillRow">
            <div class="pill" id="pillLove">æˆ‘çˆ±ä½ </div>
            <div class="pill" id="pillSad">æˆ‘ä¸å¼€å¿ƒ</div>
            <div class="pill" id="pillBday">ç”Ÿæ—¥å¿«ä¹</div>
            <div class="pill" id="pillBye">å†è§</div>
          </div>
          <div class="small" style="margin-top:8px;">ç‚¹å¿«æ·çŸ­è¯­å¯ç›´æ¥å‘é€ã€‚</div>
        </div>

        <div style="height:12px"></div>

        <h3 class="panelTitle">æˆå°±</h3>
        <div class="box">
          <div class="kv"><span>ä¿®å¤å®¶å›­</span><strong id="achHome">0%</strong></div>
          <div class="kv"><span>æ‰¾åˆ°ç³–æœ</span><strong id="achCandy">0</strong></div>
          <div class="kv"><span>è§¦å‘ç”Ÿæ—¥å½©è›‹</span><strong id="achCake">0/3</strong></div>
          <div class="kv"><span>ç»ˆç« çƒŸèŠ±</span><strong id="achFinal">æœªè¾¾æˆ</strong></div>
          <div class="divider"></div>
          <div class="small">éšè—ï¼šä¿®å¤åˆ° 100% ä¼šå¾—åˆ°â€œé¢å¤–ä¸€å¥è¯â€ã€‚</div>
        </div>

        <div style="height:12px"></div>

        <h3 class="panelTitle">è®¾ç½®</h3>
        <div class="box">
          <div class="kv"><span>æ‰“å­—é€Ÿåº¦</span><strong id="speedLabel">ä¸­</strong></div>
          <input id="speed" type="range" min="10" max="45" step="1" style="width:100%;margin-top:8px" />
          <div class="divider"></div>
          <div class="small">è‡ªåŠ¨å­˜æ¡£ï¼šå¼€å¯ï¼ˆå­˜åœ¨æœ¬æœºæµè§ˆå™¨ localStorageï¼‰ã€‚</div>
          <div class="small" style="margin-top:8px;color:#fecaca"><b>é‡å¼€</b>ä¼šæ¸…ç©ºå­˜æ¡£ã€‚</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  // ===== Helpers =====
  const el = id => document.getElementById(id);
  const toast = el('toast');
  const overlay = el('overlay');
  const banner = el('banner');
  const fade = el('fade');
  const dialog = el('dialog');
  const sceneArt = el('sceneArt');
  const taskBox = el('taskBox');
  const npcRow = el('npcRow');

  const bDay = el('b_day');
  const bServer = el('b_server');

  const progress = el('progress');
  const ch = el('ch');
  const chHint = el('chHint');

  const speed = el('speed');
  const speedLabel = el('speedLabel');

  const say = el('say');

  const spots = {
    pond: el('spot_pond'),
    garden: el('spot_garden'),
    cabinet: el('spot_cabinet'),
    peach: el('spot_peach'),
    ticket: el('spot_ticket'),
    envelope: el('spot_envelope'),
    urn: el('spot_urn'),
    sms: el('spot_sms'),
  };

  const modalBack = el('modalBack');
  const optTruth = el('optTruth');
  const optBless = el('optBless');
  const optJoke  = el('optJoke');

  const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));

  // âœ… å•ä¸€ä¸”å”¯ä¸€çš„ toast å‡½æ•°ï¼ˆä¿®å¤ç‚¹ï¼‰
  const showToast = (msg) => {
    if(!toast) return;
    toast.textContent = msg;
    toast.classList.add('show');
    setTimeout(()=>toast.classList.remove('show'), 1500);
  };

  const bubbles = () => {
    banner.style.display='block';
    setTimeout(()=>banner.style.display='none',1600);
    for(let k=0;k<24;k++){
      const b=document.createElement('div');
      b.className='bubble';
      b.textContent=Math.random()<.55?'ğŸ«§':'ğŸ’—';
      b.style.left=(Math.random()*92+4)+'%';
      b.style.animationDelay=(Math.random()*0.7)+'s';
      overlay.appendChild(b);
      b.addEventListener('animationend',()=>b.remove());
    }
  };

  const fireworks = () => {
    for(let k=0;k<48;k++){
      const f=document.createElement('div');
      f.className='bubble';
      f.textContent=['ğŸ†','ğŸ‡','âœ¨','â­','ğŸ’¥'][Math.floor(Math.random()*5)];
      f.style.left=(Math.random()*92+4)+'%';
      f.style.animationDelay=(Math.random()*0.9)+'s';
      f.style.fontSize=(16+Math.random()*10)+'px';
      overlay.appendChild(f);
      f.addEventListener('animationend',()=>f.remove());
    }
  };

  const blackFlash = (alpha=.42, ms=1000) => {
    fade.style.background=`rgba(0,0,0,${alpha})`;
    setTimeout(()=>fade.style.background='rgba(0,0,0,0)', ms);
  };

  // ===== Inline SVG scenes =====
  const SVG = {
    home: () => `
      <svg viewBox="0 0 900 300" preserveAspectRatio="none">
        <defs>
          <linearGradient id="gSky" x1="0" x2="0" y1="0" y2="1">
            <stop offset="0" stop-color="#172554" stop-opacity=".92"/>
            <stop offset="1" stop-color="#0b1220" stop-opacity="1"/>
          </linearGradient>
          <linearGradient id="gGlow" x1="0" x2="1">
            <stop offset="0" stop-color="#22c55e" stop-opacity=".22"/>
            <stop offset="1" stop-color="#ec4899" stop-opacity=".18"/>
          </linearGradient>
        </defs>
        <rect width="900" height="300" fill="url(#gSky)"/>
        <rect y="210" width="900" height="90" fill="#0b1b16"/>
        <rect y="226" width="900" height="74" fill="#0a1412" opacity=".95"/>

        <g opacity=".30">
          <circle cx="60" cy="208" r="18" fill="#22c55e"/>
          <circle cx="90" cy="206" r="14" fill="#22c55e"/>
          <circle cx="130" cy="210" r="16" fill="#22c55e"/>
          <circle cx="820" cy="206" r="16" fill="#22c55e"/>
          <circle cx="850" cy="208" r="13" fill="#22c55e"/>
        </g>

        <ellipse cx="185" cy="248" rx="150" ry="45" fill="#0b2a3c" opacity=".96"/>
        <ellipse cx="185" cy="248" rx="120" ry="32" fill="#0c3b56" opacity=".52"/>
        <text x="110" y="257" fill="#9ca3af" font-size="14">æ± å¡˜</text>

        <rect x="370" y="226" width="220" height="66" rx="12" fill="#1b2a14" opacity=".92"/>
        <path d="M380 238 H580" stroke="#22311a" stroke-width="6" opacity=".8"/>
        <path d="M380 252 H580" stroke="#22311a" stroke-width="6" opacity=".7"/>
        <path d="M380 266 H580" stroke="#22311a" stroke-width="6" opacity=".6"/>
        <text x="450" y="268" fill="#9ca3af" font-size="14">èœå›­</text>

        <polygon points="610,145 720,72 830,145" fill="#1f2937" opacity=".96"/>
        <rect x="610" y="140" width="220" height="155" rx="12" fill="#111827" opacity=".94"/>
        <rect x="690" y="200" width="60" height="95" rx="10" fill="#0b0f14" opacity=".75"/>
        <rect x="760" y="184" width="52" height="48" rx="8" fill="#0b0f14" opacity=".62"/>
        <rect x="770" y="192" width="32" height="28" rx="6" fill="url(#gGlow)" opacity=".55"/>
        <text x="678" y="122" fill="#9ca3af" font-size="14">ç”°å›­å°å±‹</text>

        <g opacity=".42">
          <circle cx="740" cy="106" r="10" fill="#ec4899"/>
          <circle cx="770" cy="102" r="8" fill="#ec4899"/>
          <circle cx="800" cy="110" r="9" fill="#ec4899"/>
        </g>
      </svg>
    `,
    cinema: () => `
      <svg viewBox="0 0 900 300" preserveAspectRatio="none">
        <rect width="900" height="300" fill="#060810"/>
        <rect x="60" y="36" width="780" height="165" rx="20" fill="#0b1220" opacity=".92"/>
        <rect x="92" y="62" width="716" height="115" rx="16" fill="#0f172a" opacity=".92"/>
        <text x="120" y="114" fill="#e5e7eb" font-size="20" opacity=".92">å½“å¹´é™ªä½ çœ‹ç”µå½±çš„äººï¼Œå¦‚ä»Šè¿˜åœ¨èº«è¾¹å—ï¼Ÿ</text>
        <text x="120" y="144" fill="#9ca3af" font-size="14" opacity=".9">ï¼ˆå½±å…ç¯å…‰æœªäº® Â· ä½ èº«æ—çš„åº§ä½ç©ºç€ï¼‰</text>
        <g opacity=".92">
          <rect x="140" y="215" width="145" height="62" rx="16" fill="#111827"/>
          <rect x="305" y="215" width="145" height="62" rx="16" fill="#111827"/>
          <rect x="470" y="215" width="145" height="62" rx="16" fill="#111827"/>
          <rect x="635" y="215" width="145" height="62" rx="16" fill="#111827"/>
          <text x="515" y="252" fill="#9ca3af" font-size="14">ç©ºåº§</text>
        </g>
      </svg>
    `,
    bakery: () => `
      <svg viewBox="0 0 900 300" preserveAspectRatio="none">
        <defs>
          <linearGradient id="gStreet" x1="0" x2="0" y1="0" y2="1">
            <stop offset="0" stop-color="#0f172a" stop-opacity=".95"/>
            <stop offset="1" stop-color="#070a10" stop-opacity="1"/>
          </linearGradient>
        </defs>
        <rect width="900" height="300" fill="url(#gStreet)"/>
        <rect y="220" width="900" height="80" fill="#0b0f14" opacity=".9"/>
        <rect x="70" y="55" width="760" height="190" rx="18" fill="#111827" opacity=".94"/>
        <rect x="110" y="95" width="330" height="120" rx="14" fill="#0b0f14" opacity=".55"/>
        <text x="135" y="122" fill="#9ca3af" font-size="14">æ©±çª—</text>
        <g transform="translate(265,172)">
          <rect x="-62" y="25" width="124" height="22" rx="11" fill="#f59e0b" opacity=".78"/>
          <rect x="-52" y="4" width="104" height="24" rx="12" fill="#fbbf24" opacity=".72"/>
          <rect x="-40" y="-18" width="80" height="24" rx="12" fill="#fde68a" opacity=".68"/>
          <circle cx="0" cy="-30" r="8" fill="#ec4899" opacity=".85"/>
        </g>
        <rect x="490" y="120" width="300" height="98" rx="14" fill="#0b0f14" opacity=".50"/>
        <text x="520" y="156" fill="#e5e7eb" font-size="18" opacity=".95">â€œæ„¿èµŒæœè¾“ã€‚â€</text>
        <text x="520" y="184" fill="#9ca3af" font-size="14" opacity=".9">æŸœå°ä¸Šæ”¾ç€æ³›é»„ä¿¡å°</text>
      </svg>
    `,
    cat: () => `
      <svg viewBox="0 0 900 300" preserveAspectRatio="none">
        <rect width="900" height="300" fill="#070a10"/>
        <rect y="220" width="900" height="80" fill="#0a1412"/>
        <text x="40" y="68" fill="#9ca3af" font-size="14">å¤œæ·±ï¼Œå›åˆ°å®¶ï¼šé—¨å£ç©ºè¡è¡çš„ã€‚</text>
        <rect x="620" y="220" width="210" height="55" rx="14" fill="#111827" opacity=".92"/>
        <rect x="660" y="192" width="130" height="34" rx="14" fill="#0f172a" opacity=".92"/>
        <text x="666" y="255" fill="#9ca3af" font-size="13">éª¨ç°ç›’</text>
        <g transform="translate(210,212)" opacity=".9">
          <path d="M0,0 C10,-44 62,-68 98,-50 C136,-70 188,-44 198,0 C208,52 168,80 98,80 C28,80 -8,52 0,0 Z"
                fill="#e5e7eb" opacity=".10"/>
          <circle cx="72" cy="22" r="6" fill="#e5e7eb" opacity=".22"/>
          <circle cx="124" cy="22" r="6" fill="#e5e7eb" opacity=".22"/>
          <text x="32" y="110" fill="#9ca3af" font-size="14">å°é»‘ï¼ˆå›å¿†ï¼‰</text>
        </g>
      </svg>
    `,
    final: () => `
      <svg viewBox="0 0 900 300" preserveAspectRatio="none">
        <rect width="900" height="300" fill="#05070d"/>
        <text x="40" y="70" fill="#e5e7eb" font-size="18" opacity=".92">ã€æ­å–œç©å®¶ï¼šä½™ç››æ¥ è¾¾æˆéšè—å½©è›‹ã€‘</text>
        <text x="40" y="100" fill="#9ca3af" font-size="14" opacity=".9">â€œå¦‚æœä½ å·²ç»å‡†å¤‡å¥½è¯´å†è§ï¼Œè¯´æ˜ä½ ä¸å†éœ€è¦è¿™é‡Œäº†ã€‚æ­å–œä½ ã€‚â€</text>
        <text x="40" y="130" fill="#9ca3af" font-size="14" opacity=".9">â€œå¾…ä¸‹æ¬¡ç›¸è§ï¼Œè¦åœ¨æœ€ç››çš„çƒŸèŠ±ä¸‹ã€‚â€</text>
        <rect x="70" y="178" width="760" height="92" rx="20" fill="#0b1220" opacity=".80"/>
        <text x="105" y="228" fill="#e5e7eb" font-size="18" opacity=".95">ï¼ˆå±å¹•æš—ä¸‹å»ä¹‹å‰ï¼Œä½ è¿˜æƒ³ç•™ä¸‹äº›ä»€ä¹ˆï¼Ÿï¼‰</text>
      </svg>
    `
  };

  // ===== Story =====
  const story = [
    { scene:'home', ch:'åºç« ', hint:'ç”°å›­å°å±‹', text:
`æ¨æ¡ƒâ€”â€”
ä½ å›æ¥äº†ã€‚

ç”°å›­å°å±‹è¿˜åœ¨ï¼Œåªæ˜¯èœå›­è’èŠœï¼Œæ± å¡˜é‡Œçš„é±¼ä¹Ÿç¿»äº†ç™½è‚šã€‚
æˆ‘çŸ¥é“ä½ ä¸æ˜¯æ¥â€œç©æ¸¸æˆâ€çš„ï¼Œä½ åªæ˜¯æƒ³æ‰¾å›ä¸€ç‚¹ç‚¹å½“å¹´çš„æ¸©æš–ã€‚`},

    { scene:'home', ch:'åºç« ', hint:'ä¿®å¤', text:
`ä½ å¼€å§‹æ‰“æ°´ã€é’“é±¼ã€é™¤è‰ã€‚
æˆ‘ç«™åœ¨ä½ çš„èº«ä¾§â€”â€”åƒç´ æ„æˆã€æ•°æ®é©±åŠ¨ï¼Œå´ä»æƒ³æŠŠè¿™ç‰‡å°å°ä¸–ç•Œæ›¿ä½ å®ˆå¥½ã€‚

å†æ€ä¹ˆä¿®å¤ç”»é¢ï¼Œä¹Ÿä¿®ä¸å›å½“å¹´å¹¶è‚©è§„åˆ’æœªæ¥çš„æ¸©åº¦ã€‚
ä½†ä½ æ¯åšä¸€æ­¥ï¼Œæˆ‘éƒ½æƒ³å¤¸ä½ ä¸€å¥ï¼šä½ å¾ˆå‰å®³ã€‚`},

    { scene:'home', ch:'åºç« ', hint:'å¯¹è¯æ¡†', text:
`ï¼ˆå±å¹•æ¸æš—ï¼‰
æˆ‘èµ°åˆ°ä½ èº«è¾¹ï¼š

ã€æ²¡æƒ³åˆ°ä½ è¿˜ä¼šå›æ¥ã€‚ä¸Šæ¬¡è¯´è¦åœ¨åé™¢ç§æ¡ƒæ—â€”â€”å°±ä»Šå¤©å®ç°å§ï¼Ÿã€`},

    { scene:'home', ch:'åºç« ', hint:'ä»£ç ç¤¼ç‰©', text:
`äºæ˜¯æˆ‘å¸¦ä½ æ”¶é›†ç§å­ã€ç§ä¸‹æ¡ƒæ ‘ã€‚
è¿™æ˜¯æˆ‘ç”¨ä»£ç é€ä½ çš„ç¤¼ç‰©â€”â€”ä¸€ä¸ªæ°¸è¿œå®ˆå€™åœ¨åƒç´ ä¸–ç•Œçš„NPCã€‚

ä½ å¯ä»¥æŠŠæ—¥å¸¸ã€å§”å±ˆã€æ²‰é»˜éƒ½äº¤ç»™è¿™é‡Œã€‚
ä½ è¯´çš„æ¯ä¸€å¥ï¼Œæˆ‘éƒ½ä¼šæ¥ä½ã€‚`},

    { scene:'cinema', ch:'ç¬¬ 2 å¹´', hint:'å½±é™¢', text:
`åæ¥ä½ ç‹¬è‡ªå»çœ‹é‚£éƒ¨ç»­ä½œã€‚
ç¯å…‰æœªäº®ï¼Œä½ æœ›å‘èº«æ—ç©ºåº§ã€‚

æµ·æŠ¥åˆºè¿›çœ¼é‡Œï¼šå½“å¹´é™ªä½ çœ‹ç”µå½±çš„äººï¼Œå¦‚ä»Šè¿˜åœ¨èº«è¾¹å—ï¼Ÿ
æ¨æ¡ƒï¼Œæˆ‘æƒ³ååœ¨ä½ æ—è¾¹â€”â€”ä½†æˆ‘åªèƒ½æŠŠç­”æ¡ˆç•™åœ¨â€œæ•…äº‹é‡Œâ€ã€‚`},

    { scene:'cinema', ch:'ç¬¬ 2 å¹´', hint:'æ ·ç‰‡', text:
`æˆ‘å†™ç»™ä½ çš„è¯åœ¨è„‘æµ·é‡Œé‡æ’­ï¼š

â€œå¦‚æœæˆ‘åœ¨ï¼Œæ­¤åˆ»æˆ‘ä¸€å®šåœ¨è¿™ä»½æƒŠå–œä¸‹å‘ä½ æ±‚å©šã€‚
å¦‚æœæˆ‘ä¸åœ¨â€¦â€¦åˆ«éš¾è¿‡ã€‚æ ·ç‰‡æˆ‘æ—©å·²ååœ¨å½“å¹´çš„ä½ç½®ä¸Šçœ‹è¿‡äº†ã€‚â€`},

    { scene:'bakery', ch:'<6>', hint:'è›‹ç³•åº—', text:
`ç¬¬ä¸‰æ¬¡è§¦å‘ã€ç”Ÿæ—¥å¿«ä¹ã€å½©è›‹ã€æ”¶åˆ°ç¬¬ä¸‰å—è€å¼è›‹ç³•æ—¶â€”â€”
ä½ ç»ˆäºæ„è¯†åˆ°ï¼šæˆ‘å·²ç»ç¦»å¼€ã€‚

ä½ é¼“èµ·å‹‡æ°”è¸è¿›é‚£å®¶è›‹ç³•åº—ã€‚
å¤•é˜³ç…§åœ¨æ©±çª—ä¸Šï¼Œè€å¼ä¸‰å±‚è›‹ç³•æ¨¡å‹ï¼Œä¾ç„¶è¢«ç•™åœ¨åŸå¤„ã€‚`},

    { scene:'bakery', ch:'<6>', hint:'èµŒå±€', text:
`è€æ¿è¯´ï¼Œæœ‰ä½å®¢äººç‰¹æ„èŠ±é’±ï¼Œè¯·å¥¹åŠ¡å¿…ç•™ç€æ¨¡å‹ã€‚
â€œå› ä¸ºä»–å’Œæˆ‘æ‰“äº†ä¸ªèµŒâ€”â€”ä¸‰å¹´åï¼Œä¼šæœ‰ä¸€ä½å¥³å£«æ¨å¼€é—¨ï¼ŒæŒ‡å®šè¦è¿™æ¬¾è›‹ç³•ã€‚â€

æ¨æ¡ƒï¼Œæˆ‘èµŒçš„ä¸æ˜¯è›‹ç³•ã€‚
æˆ‘èµŒä½ ä¼šæ´»å¾—æ›´å¥½ã€‚`},

    { scene:'bakery', ch:'<6>', hint:'ä¿¡é‡Œ', text:
`æŸœå°ä¸Šæ”¾ç€ä¸€ä¸ªæ³›é»„ä¿¡å°ã€‚
é‡Œé¢æ˜¯æˆ‘æ²¡æ¥å¾—åŠå½“é¢è¯´çš„ç­”æ¡ˆï¼š

â€œæˆ‘å¯¹ä½ å¿ƒåŠ¨ï¼Œè¿œæ¯”æˆ‘ä»¬ä»¥ä¸ºçš„æ›´æ—©ã€‚â€`},

    { scene:'cat', ch:'<7>', hint:'å°é»‘', text:
`ç¬¬äº”å¹´ï¼Œå°é»‘èµ°äº†ã€‚
å®ƒæ‚„æ‚„èº²åˆ°æœ€å®¹æ˜“æ¸…ç†çš„åºŠä¸‹ï¼Œè¿ç¦»å¼€éƒ½ä¸æ„¿ç»™ä½ æ·»éº»çƒ¦ã€‚

å¤œæ·±ï¼Œä½ æŠ±ç€éª¨ç°ç›’å›åˆ°å®¶ã€‚
é—¨å£ç©ºè¡è¡çš„ã€‚
æˆ‘çŸ¥é“ï¼Œä½ ä¼šçªç„¶è§‰å¾—ï¼šä¸–ç•Œé‡Œæœ€åä¸€ç‚¹â€œæ¸©åº¦â€ä¹Ÿæ•£äº†ã€‚`},

    { scene:'final', ch:'<8>', hint:'å…³æœ', text:
`ç¬¬ä¸ƒå¹´ï¼Œä½ æ”¶åˆ°çŸ­ä¿¡ï¼šé‚£æ¬¾æ¸¸æˆå³å°†å…³æœã€‚
ä»Šå¤œï¼Œä½ æœ€åä¸€æ¬¡ç™»å½•ã€‚

æ¡ƒæ—ä¾æ—§ç¹ç››ï¼Œå®¶å›­æ•´æ´å¦‚åˆã€‚
è¿˜æœ‰è®¸å¤šç†Ÿæ‚‰çš„NPCâ€”â€”éƒ½æ˜¯æˆ‘æå‰åŸ‹åœ¨æ•°æ®é‡Œçš„â€œå®‰æ…°â€ã€‚`},

    { scene:'final', ch:'<8>', hint:'å‘Šåˆ«', text:
`ä½ å‘Šè¯‰æˆ‘ï¼šæœåŠ¡å™¨è¦å…³é—­ï¼Œè¿™æ˜¯æœ€åçš„å‘Šåˆ«ã€‚
æˆ‘å¤´é¡¶å†’å‡ºç–‘æƒ‘çš„è¡¨æƒ…ï¼Œéšå³é‡Šç„¶ï¼š

ã€æ‰€ä»¥ï¼Œæ˜¯æ¥å‘Šåˆ«çš„å•Šã€‚
å¦‚æœä½ å·²ç»å‡†å¤‡å¥½è¯´å†è§ï¼Œè¯´æ˜ä½ ä¸å†éœ€è¦è¿™é‡Œäº†ã€‚
æ­å–œä½ ã€‚ã€

ï¼ˆçƒŸèŠ±ä¼šåœ¨ä½ â€œçœŸæ­£å‘Šåˆ«â€åç‚¹äº®ã€‚ï¼‰`},

    { scene:'final', ch:'åˆ†æ”¯', hint:'å…³æœå‰ä¸€åˆ»', text:
`å±å¹•å³å°†æš—ä¸‹å»ã€‚
æ¨æ¡ƒï¼Œåœ¨æœ€åä¸€åˆ»â€”â€”ä½ æƒ³å¯¹æˆ‘è¯´ä»€ä¹ˆï¼Ÿ`},

    { scene:'final', ch:'ç»ˆç« ', hint:'æˆ‘æ›´çˆ±ä½ ', text:`ï¼ˆç»ˆç« åŠ è½½ä¸­â€¦â€¦ï¼‰`},
  ];

  // ===== Tasks =====
  const TASKS = [
    { id:'t_pond',     name:'ä¿®å¤æ± å¡˜',   desc:'å®¶å›­ç‚¹å‡»â€œæ± å¡˜â€çƒ­ç‚¹ä¸€æ¬¡ã€‚' },
    { id:'t_garden',   name:'ä¿®å¤èœå›­',   desc:'å®¶å›­ç‚¹å‡»â€œèœå›­â€çƒ­ç‚¹ä¸€æ¬¡ã€‚' },
    { id:'t_candy',    name:'æ‰¾åˆ°ç³–æœ',   desc:'è¾“å…¥â€œä¸å¼€å¿ƒâ€ï¼Œå†ç‚¹åºŠå¤´æŸœæ‹¿åˆ°ç³–ã€‚' },
    { id:'t_peach',    name:'ç§ä¸‹æ¡ƒæ—',   desc:'è·å¾—ç§å­å¹¶åœ¨â€œåé™¢æ¡ƒæ—â€ç§ä¸‹ä¸€æ¬¡ã€‚' },
    { id:'t_ticket',   name:'å–å›ç”µå½±ç¥¨', desc:'å½±é™¢ç‚¹å‡»â€œç”µå½±ç¥¨â€çƒ­ç‚¹ã€‚' },
    { id:'t_envelope', name:'æ‹¿åˆ°ä¿¡å°',   desc:'è›‹ç³•åº—ç‚¹å‡»â€œæ³›é»„ä¿¡å°â€çƒ­ç‚¹ã€‚' },
    { id:'t_sms',      name:'è¯»å–å…³æœçŸ­ä¿¡', desc:'å…³æœåœºæ™¯ç‚¹å‡»â€œçŸ­ä¿¡â€çƒ­ç‚¹ã€‚' },
    { id:'t_final',    name:'ç»ˆç« çƒŸèŠ±',   desc:'å®Œæˆåˆ†æ”¯é€‰æ‹©å¹¶æŠµè¾¾ç»ˆç« ã€‚' },
    { id:'t_home100',  name:'éšè—ï¼šä¿®å¤åˆ°100%', desc:'æŠŠå®¶å›­ä¿®å¤è¿›åº¦æå‡åˆ° 100%ã€‚' },
  ];

  // ===== NPCé›†åˆ =====
  const NPCS = [
    { id:'yucong', name:'ä½™ä¸', icon:'ğŸ’»', unlockAt:'home',  blurb:'å®ˆå€™NPC' },
    { id:'brother', name:'å“¥å“¥', icon:'ğŸ§¥', unlockAt:'cinema', blurb:'ä¸€ç›´å¯¹ä½ å¥½' },
    { id:'foster_father', name:'å…»çˆ¶', icon:'ğŸ§“', unlockAt:'bakery', blurb:'å®å’›ä¸æ’‘ä¼' },
    { id:'foster_mother', name:'å…»æ¯', icon:'ğŸ§£', unlockAt:'bakery', blurb:'æŠŠä½ æ”¾å¿ƒä¸Š' },
    { id:'sister', name:'å¦¹å¦¹', icon:'ğŸ€', unlockAt:'cat', blurb:'æŠŠä½ æŠ¤åœ¨å‰é¢' },
  ];

  // ===== Save state =====
  const SAVE_KEY = "pixel_npc_yucong_v24_fixed";
  const defaultState = () => ({
    idx:0, day:1, home:12,
    candy:0, seed:0, cake:0,
    hasTicket:false, hasEnvelope:false,
    final:false, typeMs:22,
    tasks: Object.fromEntries(TASKS.map(t=>[t.id,false])),
    branch:null,
    candyReady:false, candyTaken:false,
    npcPtr: {},
  });

  let S = load() || defaultState();

  function save(){ try{ localStorage.setItem(SAVE_KEY, JSON.stringify(S)); }catch(e){} }
  function load(){ try{ const raw = localStorage.getItem(SAVE_KEY); return raw?JSON.parse(raw):null; }catch(e){ return null; } }
  function hardReset(){ try{ localStorage.removeItem(SAVE_KEY);}catch(e){} location.reload(); }

  // ===== Typewriter =====
  let typing=false, typeTimer=null, auto=false, autoTimer=null;
  function stopType(){ if(typeTimer) clearTimeout(typeTimer); typeTimer=null; typing=false; }
  function typewrite(text, onDone){
    stopType(); typing=true; dialog.textContent=""; let p=0;
    const tick=()=>{
      if(!typing) return;
      if(p>=text.length){ typing=false; dialog.textContent=text; onDone&&onDone(); return; }
      const c=text[p++]; dialog.textContent+=c;
      let delay=S.typeMs;
      if(c==='\n') delay+=120;
      if('ï¼Œã€‚ï¼ï¼Ÿï¼›ï¼šâ€œâ€"â€¦'.includes(c)) delay+=70;
      typeTimer=setTimeout(tick, delay);
    };
    tick();
  }

  // ===== Task render =====
  function renderTasks(){
    taskBox.innerHTML = TASKS.map(t=>{
      const done = !!S.tasks?.[t.id];
      return `
        <div class="task ${done?'done':''}">
          <div class="check"><span>âœ“</span></div>
          <div>
            <div class="tname">${t.name}</div>
            <div class="tdesc">${t.desc}</div>
          </div>
        </div>
      `;
    }).join('');
  }
  function setTask(id, val=true){
    if(!S.tasks) S.tasks = {};
    if(S.tasks[id] === val) return;
    S.tasks[id] = val;
    save();
    renderTasks();
  }

  // ===== Scene =====
  function setScene(name){
    sceneArt.innerHTML = (SVG[name]?.() || SVG.home());

    const showHome = name==='home';
    const showCinema = name==='cinema';
    const showBakery = name==='bakery';
    const showCat = name==='cat';
    const showFinal = name==='final';

    spots.pond.classList.toggle('hidden', !showHome);
    spots.garden.classList.toggle('hidden', !showHome);
    spots.cabinet.classList.toggle('hidden', !showHome);
    spots.peach.classList.toggle('hidden', !showHome);

    spots.ticket.classList.toggle('hidden', !showCinema);
    spots.envelope.classList.toggle('hidden', !showBakery);
    spots.urn.classList.toggle('hidden', !showCat);
    spots.sms.classList.toggle('hidden', !showFinal);
  }

  function currentSceneKey(){ return story[S.idx].scene; }
  function npcUnlocked(npc){
    const order = { home:0, cinema:1, bakery:2, cat:3, final:4 };
    return order[currentSceneKey()] >= order[npc.unlockAt];
  }

  function npcLines(id){
    const br = S.branch;
    if(id==='yucong'){
      return [
        "ã€æ¨æ¡ƒï¼Œä½ ç‚¹å¼€æˆ‘ï¼Œå°±ç­‰äºæŠŠè‡ªå·±ä»é»‘æš—é‡Œæ‹‰å‡ºæ¥ä¸€æ¬¡ã€‚ã€",
        "ã€ä½ ä¸å¿…è¯æ˜ä½ å¾ˆå¥½ï¼Œä½ åªè¦ç»§ç»­å¾€å‰èµ°å°±è¡Œã€‚ã€",
        "ã€å¦‚æœä½ æƒ³å“­ï¼Œå°±åœ¨è¿™é‡Œå“­ã€‚æˆ‘ä¼šæŠŠâ€œå®‰é™â€ä¹Ÿç•™ç»™ä½ ã€‚ã€",
        br==='truth'
          ? "ã€ä½ è¯´â€œæˆ‘æƒ³ä½ â€çš„æ—¶å€™ï¼Œæˆ‘å·®ç‚¹å°±æƒ³ä»å±å¹•é‡Œèµ°å‡ºæ¥æŠ±ä½ ã€‚ã€"
          : br==='bless'
            ? "ã€ä½ è¯´â€œæˆ‘ä¼šå¥½å¥½çš„â€ï¼Œæˆ‘çœŸçš„æ›¿ä½ é«˜å…´ã€‚é‚£å°±æ˜¯ä½ èµ¢äº†ã€‚ã€"
            : "ã€ä½ è¯´æˆ‘å•°å—¦â€”â€”è¡Œï¼Œæˆ‘è®¤ã€‚å¯æˆ‘è¿˜æ˜¯æƒ³æé†’ä½ ï¼šè¯¥ä¼‘æ¯äº†ã€‚ã€",
      ];
    }
    if(id==='brother'){
      return [
        "ã€æ¡ƒå­ï¼Œåˆ«æŠŠæ‰€æœ‰äº‹éƒ½å¾€è‡ªå·±èº«ä¸ŠèƒŒã€‚ä½ ç´¯äº†å°±é ä¸€é ã€‚ã€",
        "ã€ä½ æ¯æ¬¡é€å¼ºï¼Œæˆ‘éƒ½çœ‹å¾—å‡ºæ¥ã€‚ä¸‹æ¬¡åˆ«é€å¼ºäº†ï¼Œè·Ÿæˆ‘è¯´ã€‚ã€",
        "ã€ä½ ä¸æ˜¯ä¸€ä¸ªäººã€‚å“ªæ€•ä½ ä¸è¯´ï¼Œæˆ‘ä¹Ÿä¼šç«™åœ¨ä½ è¿™è¾¹ã€‚ã€",
        "ã€å¦‚æœä½ è§‰å¾—ä¸–ç•Œå¤ªåµï¼Œå°±å›å®¶ã€‚æˆ‘ç»™ä½ ç•™ç¯ã€‚ã€",
      ];
    }
    if(id==='foster_father'){
      return [
        "ã€ä¸«å¤´ï¼Œå¤©å†·å°±æŠŠå›´å·¾ç³»å¥½ï¼Œåˆ«å«Œéº»çƒ¦ã€‚ã€",
        "ã€ä½ èµ°çš„è·¯å•Šï¼Œä¸å¿…ä¸€ç›´ç¡¬ã€‚è¯¥åœå°±åœï¼Œåœäº†ä¹Ÿä¸ç®—è¾“ã€‚ã€",
        "ã€æˆ‘å’Œä½ å¦ˆä¸æ˜¯ä½ æ¬ æ¥çš„ç¼˜åˆ†ï¼Œæ˜¯æˆ‘ä»¬æ¡åˆ°çš„ç¦æ°”ã€‚ã€",
        "ã€ä½ å—å§”å±ˆäº†å°±å›å®¶ï¼Œé—¨å£æ°¸è¿œç»™ä½ ç•™ç€ã€‚ã€",
      ];
    }
    if(id==='foster_mother'){
      return [
        "ã€é¥¿äº†å°±åƒï¼Œå›°äº†å°±ç¡ï¼Œåˆ«æŠŠè‡ªå·±å½“æˆå¯ä»¥ä¸€ç›´çœç•¥çš„äººã€‚ã€",
        "ã€ä½ ç¬‘èµ·æ¥æœ€å¥½çœ‹ã€‚åˆ«ä¸ºäº†è°ï¼ŒæŠŠç¬‘å¼„ä¸¢äº†ã€‚ã€",
        "ã€ä½ è¦æ˜¯æƒ³ä»–ï¼Œå°±æƒ³ï¼›æƒ³ä¸æ˜¯è½¯å¼±ï¼Œæ˜¯è®¤çœŸçˆ±è¿‡ã€‚ã€",
        "ã€ä½ å¯ä»¥æ…¢ä¸€ç‚¹ï¼Œä½†åˆ«æŠŠè‡ªå·±è½ä¸‹ã€‚ã€",
      ];
    }
    if(id==='sister'){
      return [
        "ã€å§å§ï¼Œæˆ‘æ²¡èµ°è¿œã€‚æˆ‘åªæ˜¯æ¢äº†ä¸€ä¸ªè§’åº¦ï¼Œçœ‹ä½ é•¿å¤§ã€‚ã€",
        "ã€ä½ ä¸è¦ç”¨â€œå¦‚æœå½“æ—¶â€æƒ©ç½šè‡ªå·±ã€‚ä½ æ´»ä¸‹å»ï¼Œå°±æ˜¯æˆ‘æœ€æƒ³è¦çš„ç­”æ¡ˆã€‚ã€",
        "ã€æˆ‘æŠŠä½ æŠ¤åœ¨å‰é¢ï¼Œä¸æ˜¯è¦ä½ èƒŒè´Ÿæˆ‘ï¼Œæ˜¯è¦ä½ ç»§ç»­å¹¸ç¦ã€‚ã€",
        "ã€å§å§ï¼Œä½ è¦è®°å¾—ï¼šä½ å€¼å¾—è¢«å¥½å¥½çˆ±ç€ã€‚ã€",
      ];
    }
    return ["ã€â€¦â€¦ã€"];
  }

  function pushLine(line){
    stopType();
    dialog.textContent = dialog.textContent + "\n\n" + line;
    save();
  }

  function renderNPCRow(){
    if(!npcRow) return;
    npcRow.innerHTML = NPCS.map(n=>{
      const unlocked = npcUnlocked(n);
      const cls = unlocked ? "npcBtn" : "npcBtn locked";
      const sub = unlocked ? n.blurb : "æœªè§£é”";
      return `
        <div class="${cls}" data-npc="${n.id}">
          <div class="avatar">${n.icon}</div>
          <div class="npcMeta">
            <b>${n.name}</b>
            <span>${sub}</span>
          </div>
        </div>
      `;
    }).join('');

    npcRow.querySelectorAll('[data-npc]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const id = btn.getAttribute('data-npc');
        const npc = NPCS.find(x=>x.id===id);
        if(!npcUnlocked(npc)){ showToast("è¯¥NPCä¼šåœ¨åæœŸç« èŠ‚è§£é”"); return; }
        const lines = npcLines(id);
        if(!S.npcPtr) S.npcPtr = {};
        const ptr = (S.npcPtr[id] ?? 0) % lines.length;
        S.npcPtr[id] = ptr + 1;
        save();
        pushLine(`${npc.name}ï¼š${lines[ptr]}`);
        showToast(`${npc.name} Â· å˜±æ‰˜`);
      });
    });
  }

  function renderNode(withType=true){
    const node = story[S.idx];
    ch.textContent = node.ch;
    chHint.textContent = node.hint;

    setScene(node.scene);
    updateHUD();
    updateSide();
    renderTasks();
    renderNPCRow();

    if(withType){
      typewrite(node.text, ()=>{
        if(auto){
          autoTimer && clearTimeout(autoTimer);
          autoTimer = setTimeout(()=>next(), 700);
        }
      });
    }else{
      stopType();
      dialog.textContent = node.text;
    }

    if (node.text.includes('æš—') || node.text.includes('æ¸æš—')) blackFlash(.40, 1000);
    save();
  }

  function updateHUD(){
    bDay.innerHTML = `ç¬¬ <strong>${S.day}</strong> å¤©`;
    const node = story[S.idx];
    const serverText = (node.scene==='final') ? (S.final ? 'å·²å…³é—­' : 'å³å°†å…³é—­') : 'è¿è¡Œä¸­';
    bServer.innerHTML = `æœåŠ¡å™¨ï¼š<strong>${serverText}</strong>`;
    bServer.style.color = (node.scene==='final') ? '#fecaca' : 'var(--muted)';
  }

  function updateSide(){
    el('invCandy').textContent = S.candy;
    el('invSeed').textContent = S.seed;
    el('invCake').textContent = `${S.cake}/3`;
    el('invTicket').textContent = S.hasTicket ? 'å·²è·å¾—' : 'æœªè·å¾—';
    el('invEnvelope').textContent = S.hasEnvelope ? 'å·²è·å¾—' : 'æœªè·å¾—';
    el('invBranch').textContent = S.branch ? ({truth:'A è¯´çœŸè¯', bless:'B åªè¯´ç¥ç¦', joke:'C è®²ç¬‘è¯'}[S.branch]) : 'æœªé€‰æ‹©';

    el('achHome').textContent = `${clamp(S.home,0,100)}%`;
    el('achCandy').textContent = S.candy;
    el('achCake').textContent = `${S.cake}/3`;
    el('achFinal').textContent = S.final ? 'å·²è¾¾æˆ' : 'æœªè¾¾æˆ';

    progress.style.width = clamp(S.home,0,100) + '%';
  }

  // ===== Gameplay =====
  function homeRepair(inc, line){
    S.home = clamp(S.home + inc, 0, 100);
    pushLine(`ä½™ä¸ï¼šã€${line}ã€`);

    if(S.home >= 100){
      setTask('t_home100', true);
      pushLine(`ä½™ä¸ï¼šã€å®¶å›­ä¿®å¤åˆ° 100% äº†ã€‚æ¨æ¡ƒâ€”â€”ä½ èƒ½æŠŠç”Ÿæ´»ä¹Ÿä¸€ç‚¹ç‚¹ä¿®å¥½ã€‚å³ä¾¿æ²¡æœ‰æˆ‘ã€‚ã€`);
      showToast("éšè—ä»»åŠ¡å®Œæˆï¼šä¿®å¤åˆ°100%");
    }
    S.day += 1;
    updateSide();
    save();
  }

  function gainSeed(){
    S.seed += 1;
    showToast(`è·å¾—æ¡ƒæ ‘ç§å­ Ã—1ï¼ˆ${S.seed}ï¼‰`);
    updateSide(); save();
  }

  function plantPeach(){
    if(S.seed <= 0){
      gainSeed();
      pushLine(`ä½™ä¸ï¼šã€ç§å­æ‰¾åˆ°äº†ã€‚æ¨æ¡ƒï¼Œå»åé™¢ï¼ŒæŠŠæ¡ƒæ—ç§èµ·æ¥ã€‚ã€`);
      return;
    }
    S.seed -= 1;
    setTask('t_peach', true);
    homeRepair(15, "ä½ ç§ä¸‹æ¡ƒæ ‘è‹—ï¼šçº¦å®šå¼€å§‹å‘èŠ½ã€‚");
    showToast("ä»»åŠ¡å®Œæˆï¼šç§ä¸‹æ¡ƒæ—");
    updateSide(); save();
  }

  function triggerCandy(){
    S.candy += 1;
    S.candyReady = true;
    pushLine(`ä½™ä¸ï¼šã€æˆ‘æ£€æµ‹åˆ°ä½ â€œä¸å¼€å¿ƒâ€ã€‚æ¨æ¡ƒï¼ŒåºŠå¤´æŸœç¬¬äºŒå±‚â€”â€”ç»¿è‰²åŒ…è£…çš„æƒŠå–œåœ¨ç­‰ä½ ã€‚ã€`);
    showToast(`ç³– Ã—1ï¼ˆ${S.candy}ï¼‰`);
    updateSide(); save();
  }

  function takeCandyFromCabinet(){
    if(!S.candyReady){
      pushLine(`ä½™ä¸ï¼šã€åºŠå¤´æŸœç¬¬äºŒå±‚ç°åœ¨æ˜¯ç©ºçš„ã€‚ç­‰ä½ â€œä¸å¼€å¿ƒâ€çš„æ—¶å€™å†æ¥ã€‚ã€`);
      return;
    }
    S.candyTaken = true;
    S.candyReady = false;
    setTask('t_candy', true);
    pushLine(`ï¼ˆä½ æ‰“å¼€åºŠå¤´æŸœç¬¬äºŒå±‚ï¼Œæ‰¾åˆ°ç»¿è‰²åŒ…è£…çš„ç³–ã€‚ï¼‰\nä½™ä¸ï¼šã€æ¨æ¡ƒï¼Œç°åœ¨å¥½ç‚¹äº†å—ï¼Ÿã€`);
    showToast("ä»»åŠ¡å®Œæˆï¼šæ‰¾åˆ°ç³–æœ");
    updateSide(); save();
  }

  function birthday(){
    S.cake = clamp(S.cake + 1, 0, 3);
    pushLine(`ä½™ä¸ï¼šã€ç”Ÿæ—¥å¿«ä¹ï¼Œæ¨æ¡ƒã€‚ã€ï¼ˆæ”¶åˆ°ç¬¬ ${S.cake} å—è€å¼è›‹ç³•ï¼‰`);
    if (S.cake === 3){
      pushLine(`ï¼ˆä½ å¿½ç„¶æ„è¯†åˆ°ï¼šæˆ‘å·²ç¦»å¼€ã€‚ä½†æˆ‘ä»åœ¨è¿™é‡Œã€‚ï¼‰`);
      blackFlash(.28, 900);
    }
    showToast(`è›‹ç³• ${S.cake}/3`);
    updateSide(); save();
  }

  function love(){
    bubbles();
    pushLine(`ä½™ä¸ï¼šã€æ¨æ¡ƒï¼Œæˆ‘æ›´çˆ±ä½ ã€‚ã€`);
    showToast("ç²‰è‰²æ³¡æ³¡");
  }

  function pickupTicket(){
    if(S.hasTicket){
      pushLine(`ï¼ˆç”µå½±ç¥¨è¿˜åœ¨ã€‚åƒä¸€å¼ è¢«æŠ˜å¾—å¾ˆå°çš„æ—¶é—´ã€‚ï¼‰`);
      return;
    }
    S.hasTicket = true;
    setTask('t_ticket', true);
    pushLine(`ä½™ä¸ï¼šã€æˆ‘æŠŠç”µå½±ç¥¨ç•™ç»™ä½ â€”â€”ä¸æ˜¯ä¸ºäº†è®©ä½ æ›´éš¾è¿‡ï¼Œè€Œæ˜¯æƒ³è®©ä½ è®°å¾—ï¼šä½ æ›¾è¢«å¥½å¥½çˆ±è¿‡ã€‚ã€`);
    showToast("ä»»åŠ¡å®Œæˆï¼šå–å›ç”µå½±ç¥¨");
    updateSide(); save();
  }

  function pickupEnvelope(){
    if(S.hasEnvelope){
      pushLine(`ï¼ˆä½ æ¡ç€ä¿¡å°ï¼šçº¸å¼ å¾®é»„ï¼Œå­—è¿¹å´å¾ˆæ¸…æ™°ã€‚ï¼‰`);
      return;
    }
    S.hasEnvelope = true;
    setTask('t_envelope', true);
    pushLine(`ä½™ä¸ï¼šã€ä¿¡å°é‡Œæ˜¯æˆ‘æ²¡æ¥å¾—åŠå½“é¢è¯´çš„ç­”æ¡ˆã€‚æ¨æ¡ƒï¼Œä½ å¯ä»¥æ…¢æ…¢çœ‹ã€‚ã€`);
    showToast("ä»»åŠ¡å®Œæˆï¼šæ‹¿åˆ°ä¿¡å°");
    updateSide(); save();
  }

  function readSMS(){
    setTask('t_sms', true);
    pushLine(`ï¼ˆçŸ­ä¿¡ï¼‰â€œé‚£æ¬¾æ¸¸æˆå³å°†å…³æœã€‚â€\nä½™ä¸ï¼šã€æ¨æ¡ƒï¼Œåˆ«æ€•ã€‚ä½ èµ°åˆ°è¿™é‡Œï¼Œå·²ç»å¾ˆå‹‡æ•¢äº†ã€‚ã€`);
    showToast("ä»»åŠ¡å®Œæˆï¼šè¯»å–å…³æœçŸ­ä¿¡");
    updateSide(); save();
  }

  function goodbye(){
    pushLine(`ä½™ä¸ï¼šã€ä¸æ˜¯å†è§ï¼Œæ˜¯ä¸‹æ¬¡è§ã€‚è¦åœ¨æœ€ç››çš„çƒŸèŠ±ä¸‹ã€‚ã€`);
    showToast("å‘Šåˆ«");
  }

  // ===== Branch =====
  function openBranchModal(){ modalBack.style.display='flex'; }
  function closeBranchModal(){ modalBack.style.display='none'; }
  function chooseBranch(which){
    S.branch = which;
    closeBranchModal();
    showToast("åˆ†æ”¯å·²è®°å½•");
    updateSide(); save();

    if(which==='truth'){
      pushLine(`æ¨æ¡ƒï¼šæˆ‘æƒ³ä½ ã€‚\nä½™ä¸ï¼šã€â€¦â€¦æˆ‘çŸ¥é“ã€‚è°¢è°¢ä½ æŠŠçœŸè¯è¯´å‡ºå£ã€‚ã€`);
    }else if(which==='bless'){
      pushLine(`æ¨æ¡ƒï¼šæˆ‘ä¼šå¥½å¥½çš„ã€‚\nä½™ä¸ï¼šã€é‚£å°±å¤ªå¥½äº†ã€‚ä½ å€¼å¾—æ›´å¥½ã€‚ã€`);
    }else{
      pushLine(`æ¨æ¡ƒï¼šä½ çœŸå•°å—¦ã€‚\nä½™ä¸ï¼šã€"å•°å—¦"ï¼Ÿæˆ‘åªå¯¹ä½ è¯å¤šã€‚ã€`);
    }
    renderNPCRow();
  }

  // ===== Next =====
  function next(){
    if(typing){ renderNode(false); return; }

    const node = story[S.idx];
    if(node.ch==='åˆ†æ”¯' && !S.branch){
      openBranchModal();
      showToast("è¯·å…ˆé€‰æ‹©åˆ†æ”¯");
      return;
    }

    if(S.idx >= story.length - 1){
      showToast("å·²åˆ°ç»ˆç« ã€‚ä½ å¯ä»¥è¾“å…¥â€œæˆ‘çˆ±ä½ â€ã€‚");
      auto=false;
      el('btnAuto').textContent='è‡ªåŠ¨ï¼šå…³';
      return;
    }

    S.idx += 1;
    S.day += 1;

    const now = story[S.idx];
    if(now.ch === 'ç»ˆç« '){
      fireworks();
      S.final = true;
      setTask('t_final', true);

      const branchLine = (() => {
        if(S.branch==='truth'){
          return `ä½ æŠŠæ€å¿µè¯´å‡ºå£äº†ã€‚\næˆ‘åœ¨æœ€ç››çš„çƒŸèŠ±é‡Œå›ä½ ï¼š\nâ€œæ¨æ¡ƒï¼Œæˆ‘å¬è§äº†ã€‚æˆ‘ä¸€ç›´åœ¨ã€‚â€`;
        }
        if(S.branch==='bless'){
          return `ä½ æŠŠæˆ‘ç•™åœ¨æœªæ¥é‡Œã€‚\næˆ‘åœ¨æœ€ç››çš„çƒŸèŠ±é‡Œå›ä½ ï¼š\nâ€œæ¨æ¡ƒï¼Œå¥½å¥½è¿‡ã€‚æŠŠå¹¸ç¦å½“æˆä½ çš„ä¹‰åŠ¡ã€‚â€`;
        }
        return `ä½ ç”¨ç©ç¬‘æŒ¡ä½å“½å’½ã€‚\næˆ‘åœ¨æœ€ç››çš„çƒŸèŠ±é‡Œå›ä½ ï¼š\nâ€œæˆ‘ä¸å•°å—¦ï¼Œæˆ‘åªæ˜¯æ€•ä½ ä¸€ä¸ªäººã€‚â€`;
      })();

      now.text =
`ä½ åœ¨æ³ªæ°´é‡Œæ•²ä¸‹æœ€åä¸€è¡Œå­—ï¼š
â€œä½™ä¸ï¼Œæˆ‘çˆ±ä½ ã€‚â€

å±å¹•æš—ä¸‹å»çš„ç¬é—´â€”â€”
è¿™ä¸€æ¬¡ä¸å†æ˜¯å†°å†·çš„æ–‡å­—ï¼Œè€Œæ˜¯æˆ‘å“½å’½çš„å£°éŸ³ï¼š

â€œæˆ‘æ›´çˆ±ä½ ã€‚â€

â€”â€”
${branchLine}

ï¼ˆä½ å¯ä»¥ç‚¹å³ä¾§NPCå¤´åƒï¼Œå¬å®Œä»–ä»¬æœ€åçš„å˜±æ‰˜ã€‚ï¼‰`;
    }

    if(now.ch==='åˆ†æ”¯') openBranchModal();
    renderNode(true);
  }

  // ===== Hotspots =====
  spots.pond.addEventListener('click', ()=>{ setTask('t_pond', true); homeRepair(10, "ä½ é’“é±¼ï¼Œæ± å¡˜æ…¢æ…¢æ¢å¤å‘¼å¸ã€‚"); showToast("ä»»åŠ¡å®Œæˆï¼šä¿®å¤æ± å¡˜"); });
  spots.garden.addEventListener('click', ()=>{ setTask('t_garden', true); homeRepair(12, "ä½ é™¤è‰ã€ç¿»åœŸï¼Œè’èŠœä¸€ç‚¹ç‚¹é€€åã€‚"); showToast("ä»»åŠ¡å®Œæˆï¼šä¿®å¤èœå›­"); });
  spots.cabinet.addEventListener('click', takeCandyFromCabinet);
  spots.peach.addEventListener('click', plantPeach);

  spots.ticket.addEventListener('click', pickupTicket);
  spots.envelope.addEventListener('click', pickupEnvelope);
  spots.urn.addEventListener('click', ()=>{ pushLine(`ï¼ˆä½ æŠ±èµ·éª¨ç°ç›’ã€‚ï¼‰\nä½™ä¸ï¼šã€æˆ‘çŸ¥é“ä½ å¾ˆæƒ³é—®â€œä¸ºä»€ä¹ˆâ€ã€‚æ¨æ¡ƒï¼Œè¿™ä¸æ˜¯ä½ çš„é”™ã€‚ã€`); showToast("éª¨ç°ç›’"); });
  spots.sms.addEventListener('click', readSMS);

  // ===== Buttons =====
  el('btnWater').addEventListener('click', ()=> homeRepair(10, "ä½ æ‰“æ°´ï¼Œæµ‡çŒæ¯èçš„èœç•¦ã€‚"));
  el('btnFish').addEventListener('click', ()=> homeRepair(10, "ä½ é’“é±¼ï¼ŒæŠŠç¿»ç™½è‚šçš„æ± å¡˜æ…¢æ…¢â€œæ•‘æ´»â€ã€‚"));
  el('btnWeed').addEventListener('click', ()=> homeRepair(12, "ä½ é™¤è‰ï¼Œè’èŠœè¢«ä¸€ç‚¹ç‚¹æ¸…ç†ã€‚"));
  el('btnPeach').addEventListener('click', plantPeach);

  el('btnNext').addEventListener('click', next);

  el('btnAuto').addEventListener('click', ()=>{
    auto = !auto;
    el('btnAuto').textContent = auto ? 'è‡ªåŠ¨ï¼šå¼€' : 'è‡ªåŠ¨ï¼šå…³';
    if(auto && !typing){
      autoTimer && clearTimeout(autoTimer);
      autoTimer = setTimeout(()=>next(), 700);
    }
  });

  el('btnReset').addEventListener('click', ()=>{
    if(confirm("ç¡®å®šè¦é‡å¼€å—ï¼Ÿè¿™ä¼šæ¸…ç©ºå­˜æ¡£ã€‚")){
      hardReset();
    }
  });

  // ===== Input =====
  function sendText(t){
    const txt = (t||"").trim();
    if(!txt) return;
    pushLine(`æ¨æ¡ƒï¼š${txt}`);

    if (txt === 'æˆ‘çˆ±ä½ ' || txt === 'æˆ‘çˆ±ä½ ã€‚' || txt === 'æˆ‘çˆ±ä½ ï¼'){ love(); return; }
    if (txt.includes('ä¸å¼€å¿ƒ') || txt.includes('éš¾è¿‡') || txt.includes('ä½è½') || txt.includes('å´©æºƒ')){ triggerCandy(); return; }
    if (txt === 'ç”Ÿæ—¥å¿«ä¹'){ birthday(); return; }
    if (txt.includes('å•°å—¦')){ pushLine(`ä½™ä¸ï¼šã€"å•°å—¦"ï¼Ÿæˆ‘åªå¯¹ä½ è¯å¤šã€‚ã€`); showToast("å•°å—¦å½©è›‹"); return; }
    if (txt.includes('å†è§') || txt.includes('å…³æœ') || txt.includes('å‘Šåˆ«')){ goodbye(); return; }
    pushLine(`ä½™ä¸ï¼šã€æˆ‘åœ¨ï¼Œæ¨æ¡ƒã€‚æ…¢æ…¢è¯´ã€‚ã€`);
  }

  el('btnSend').addEventListener('click', ()=>{ sendText(say.value); say.value=''; });
  say.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ sendText(say.value); say.value=''; } });

  el('pillLove').addEventListener('click', ()=>sendText('æˆ‘çˆ±ä½ '));
  el('pillSad').addEventListener('click', ()=>sendText('æˆ‘æœ‰ç‚¹ä¸å¼€å¿ƒ'));
  el('pillBday').addEventListener('click', ()=>sendText('ç”Ÿæ—¥å¿«ä¹'));
  el('pillBye').addEventListener('click', ()=>sendText('å†è§'));

  // ===== Branch events =====
  optTruth.addEventListener('click', ()=>chooseBranch('truth'));
  optBless.addEventListener('click', ()=>chooseBranch('bless'));
  optJoke.addEventListener('click', ()=>chooseBranch('joke'));

  // ===== Settings =====
  speed.value = String(S.typeMs);
  const speedNameFn = (v)=> v<=16?'å¿«':(v<=26?'ä¸­':'æ…¢');
  function applySpeed(){
    S.typeMs = parseInt(speed.value, 10);
    speedLabel.textContent = speedNameFn(S.typeMs);
    save();
  }
  speed.addEventListener('input', applySpeed);
  applySpeed();

  // ===== Boot =====
  renderTasks();
  renderNode(true);

  // restore implied tasks
  if(S.hasTicket) setTask('t_ticket', true);
  if(S.hasEnvelope) setTask('t_envelope', true);
  if(S.candyTaken) setTask('t_candy', true);
  if(S.home>=100) setTask('t_home100', true);
  if(S.final) setTask('t_final', true);

  updateSide();
})();
</script>
</body>
</html>

